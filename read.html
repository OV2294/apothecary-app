<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Read Manga - The Apothecary Diaries</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/jpg" href="image/logo.jpeg">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'glass-border': 'rgba(255, 255, 255, 0.2)',
                        'glass-bg': 'rgba(255, 255, 255, 0.2)',
                        'theme-orange': '#ffb26b',
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.1)',
                        'glow': '0 0 15px rgba(255, 178, 107, 0.3)',
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                @apply backdrop-blur-md bg-glass-bg border border-glass-border shadow-glass rounded-2xl;
            }
            .nav-link {
                @apply text-white font-bold text-lg hover:text-theme-orange transition-colors duration-300;
            }
            .nav-btn {
                @apply px-4 py-2 bg-white text-theme-orange border border-white/20 rounded-lg hover:bg-theme-orange hover:text-black transition-all font-bold text-sm flex items-center gap-2;
            }
            .nav-btn:disabled {
                @apply opacity-50 cursor-not-allowed hover:bg-white hover:text-theme-orange;
            }
        }
    </style>
</head>

<body class="bg-black font-sans min-h-screen text-white relative">

    <img src="image/apothbgland.png" alt="Background"
        class="fixed inset-0 w-full h-full -z-10 hidden md:block opacity-90 transition-opacity duration-700">
    <img src="image/apothbgport.png " alt="Background"
        class="fixed inset-0 w-full h-full -z-10 block md:hidden opacity-90 transition-opacity duration-700">

    <header class="fixed top-0 w-full z-50 px-4 py-3">
        <nav class="glass flex items-center justify-between px-6 py-3 max-w-7xl h-20 mx-auto">
            <div class="flex items-center gap-8">
                <a href="index.html" class="w-20 h-15 overflow-hidden hover:scale-105 transition-transform">
                    <img src="image/logo1.png" alt="Logo" class="w-full h-full">
                </a>
                <ul class="hidden md:flex gap-8">
                    <li><a href="Anime.html" class="nav-link">Anime</a></li>
                    <li><a href="manga.html" class="nav-link text-theme-orange">Manga</a></li>
                    <li><a href="character.html" class="nav-link">Characters</a></li>
                    <li><a href="about.html" class="nav-link">About</a></li>
                </ul>
            </div>

            <div class="flex items-center gap-4">
                <a id="user-icon-link" href="auth.html"
                    class="w-10 h-10 rounded-full overflow-hidden border border-white/50 hover:border-theme-orange transition-colors">
                    <img id="nav-avatar" src="image/accicon.png" alt="Account" class="w-full h-full object-cover">
                </a>
                <button id="mobile-menu-btn" class="md:hidden text-white text-3xl focus:outline-none">â‰¡</button>
            </div>
        </nav>

        <div id="mobile-menu"
            class="hidden absolute top-20 right-4 w-48 glass flex-col items-center py-4 space-y-4 md:hidden">
            <a href="Anime.html" class="nav-link text-base">Anime</a>
            <a href="manga.html" class="nav-link text-base text-theme-orange">Manga</a>
            <a href="character.html" class="nav-link text-base">Characters</a>
            <a href="about.html" class="nav-link text-base">About</a>
        </div>
    </header>

    <main class="pt-32 pb-20 px-4 max-w-5xl mx-auto flex flex-col gap-6">

        <div
            class="p-4 bg-glass-bg backdrop-blur-2xl flex flex-col md:flex-row justify-between items-center gap-4 border-glass-border shadow-glass rounded-2xl">

            <h1 class="text-xl font-bold md:text-theme-orange" id="chapter-title">Loading...</h1>

            <div class="flex items-center gap-3">
                <button id="prev-chapter-top" class="nav-btn"><i class="fa-solid fa-chevron-left"></i> Prev</button>
                <select id="chapter-select"
                    class="bg-white text-theme-orange border border-white/20 rounded px-2 py-1 text-sm focus:outline-none focus:border-theme-orange">
                    <option value="1" disabled selected>Chapter 1</option>
                </select>
                <button id="next-chapter-top" class="nav-btn">Next <i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="reader-container"
            class=" pt-10 relative z-0 w-full h-[85vh] bg-black/20 rounded-xl overflow-hidden shadow-2xl">
            <iframe id="manga-frame" class="w-full h-full rounded-lg border border-white/10" src=""
                allow="autoplay"></iframe>
        </div>

        <div class="glass p-6 flex justify-between items-center">
            <button id="prev-chapter-btm" class="nav-btn"><i class="fa-solid fa-chevron-left"></i> Prev Chapter</button>
            <button id="scroll-top"
                class="p-3 bg-white text-theme-orange rounded-full hover:bg-theme-orange hover:text-black transition-all shadow-lg"
                title="Back to Top">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
            <button id="next-chapter-btm" class="nav-btn">Next Chapter <i
                    class="fa-solid fa-chevron-right"></i></button>
        </div>

    </main>

    <footer
        class="py-8 text-center text-white/90 text-sm relative z-10 glass rounded-t-2xl mx-auto w-[95%] max-w-7xl mb-4">
        <p class="font-bold">&copy; 2026 The Apothecary Diaries Project.</p>
        <p class="mt-2 px-4 opacity-80 max-w-2xl mx-auto">
            <strong>Disclaimer:</strong> This website is developed strictly for
            <span class="text-theme-orange">educational and portfolio purposes only</span>.
            We do not own the rights to the anime, characters, or media content.
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        let allChapters = [];
        let currentChapterNum = 1;
        let currentUser = null;

        document.addEventListener("DOMContentLoaded", async () => {

            const mobileBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileBtn) {
                mobileBtn.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                    mobileMenu.classList.toggle('flex');
                });
            }

            await checkAuth();

            const params = new URLSearchParams(window.location.search);
            if (params.has('chapter')) currentChapterNum = parseFloat(params.get('chapter'));

            await initReader();

            document.getElementById('chapter-select').addEventListener('change', (e) => {
                changeChapter(parseFloat(e.target.value));
            });

            ['top', 'btm'].forEach(pos => {
                document.getElementById(`prev-chapter-${pos}`).addEventListener('click', () => changeChapter(currentChapterNum - 1));
                document.getElementById(`next-chapter-${pos}`).addEventListener('click', () => changeChapter(currentChapterNum + 1));
            });

            document.getElementById('scroll-top').addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') changeChapter(currentChapterNum - 1);
                if (e.key === 'ArrowRight') changeChapter(currentChapterNum + 1);
            });
        });

        async function checkAuth() {
            try {
                const res = await fetch('/auth/me?t=' + Date.now(), { credentials: 'include' });
                const data = await res.json();

                if (!data.loggedIn) {
                    window.location.href = 'auth.html';
                    return;
                }

                currentUser = data.user;
                const navAvatar = document.getElementById('nav-avatar');
                if (navAvatar && currentUser.avatar_id) navAvatar.src = currentUser.avatar_id;

                const userLink = document.getElementById('user-icon-link');
                if (userLink) userLink.href = (currentUser.role === 'admin') ? 'admin.html' : 'user.html';

            } catch (err) { console.error("Auth check failed", err); }
        }

        async function initReader() {
            try {
                const res = await fetch('/manga');
                if (res.status === 401) { window.location.href = 'auth.html'; return; }

                const data = await res.json();

                if (data && data.length > 0) {
                    allChapters = data.sort((a, b) => a.chapter - b.chapter);

                    populateDropdown();
                    loadChapterContent(currentChapterNum);
                } else {
                    document.getElementById('chapter-title').textContent = "No Chapters Found";
                }
            } catch (e) {
                console.error("Error loading manga list", e);
            }
        }

        function populateDropdown() {
            const select = document.getElementById('chapter-select');
            select.innerHTML = '';

            allChapters.forEach(ch => {
                const opt = document.createElement('option');

                opt.value = ch.chapter;
                opt.textContent = ch.title; 

                if (ch.chapter == currentChapterNum) opt.selected = true;
                select.appendChild(opt);
            });

            select.value = currentChapterNum;
        }

        function loadChapterContent(chapterNum) {
            const titleEl = document.getElementById('chapter-title');
            const iframeEl = document.getElementById('manga-frame');
            const chapterData = allChapters.find(c => c.chapter == chapterNum);

            if (chapterData) {
                titleEl.textContent = chapterData.title;

                let link = chapterData.pdf_link;

                if (link && link.includes('/view')) {
                    link = link.replace('/view', '/preview');
                }

                if (iframeEl) iframeEl.src = link;
                const newUrl = `${window.location.pathname}?chapter=${chapterNum}`;
                window.history.pushState({ path: newUrl }, '', newUrl);

                document.getElementById('chapter-select').value = chapterNum;
                updateControls();
            } else {
                titleEl.textContent = `Chapter ${chapterNum} Not Found`;
                if (typeof Toastify !== 'undefined') {
                    Toastify({ text: "Chapter not available", style: { background: "#ff5f6d" } }).showToast();
                }
            }
        }

        function changeChapter(newChap) {
            const exists = allChapters.some(c => c.chapter == newChap);

            if (exists) {
                currentChapterNum = newChap;
                loadChapterContent(currentChapterNum);
            } else {
                Toastify({ text: "No more chapters.", style: { background: "#333" } }).showToast();
            }
        }

        function updateControls() {
            const currentIndex = allChapters.findIndex(c => c.chapter == currentChapterNum);

            const hasPrev = currentIndex > 0;
            const hasNext = currentIndex < allChapters.length - 1;

            ['top', 'btm'].forEach(pos => {
                const prevBtn = document.getElementById(`prev-chapter-${pos}`);
                const nextBtn = document.getElementById(`next-chapter-${pos}`);

                if (prevBtn) prevBtn.disabled = !hasPrev;
                if (nextBtn) nextBtn.disabled = !hasNext;
            });
        }

    </script>
</body>

</html>