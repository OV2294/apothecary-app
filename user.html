<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - The Apothecary Diaries</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/jpg" href="image/logo.jpeg">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'glass-border': 'rgba(255, 255, 255, 0.2)',
                        'glass-bg': 'rgba(255, 255, 255, 0.2)',
                        'theme-orange': '#ffb26b',
                    },
                    boxShadow: { 'glass': '0 4px 30px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass { @apply backdrop-blur-md bg-glass-bg border border-glass-border shadow-glass rounded-2xl; }
            .nav-link { @apply text-white font-bold text-lg hover:text-theme-orange transition-colors duration-300; }
            .profile-input { @apply w-full bg-black/20 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-theme-orange; }
         
            .fav-item { @apply flex justify-between items-center bg-white/5 border border-white/10 p-3 rounded-lg mb-2 hover:bg-white/10 transition-colors; }
        }
    </style>
</head>

<body class="bg-black font-sans min-h-screen text-white relative">

    <img src="image/apothbgland.png" alt="Background"
        class="fixed inset-0 w-full h-full -z-10 hidden md:block opacity-90 transition-opacity duration-700">
    <img src="image/apothbgport.png" alt="Background"
        class="fixed inset-0 w-full h-full -z-10 block md:hidden opacity-90 transition-opacity duration-700">

    <header class="fixed top-0 w-full z-50 px-4 py-3">
        <nav class="glass flex items-center justify-between px-6 py-3 max-w-7xl h-20 mx-auto">
            <div class="flex items-center gap-8">
                <a href="index.html"><img src="image/logo1.png" class="h-12 hover:scale-105 transition-transform"></a>
                <ul class="hidden md:flex gap-8">
                    <li><a href="Anime.html" class="nav-link">Anime</a></li>
                    <li><a href="manga.html" class="nav-link">Manga</a></li>
                    <li><a href="character.html" class="nav-link">Characters</a></li>
                    <li><a href="about.html" class="nav-link">About</a></li>
                </ul>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="logout()" class="text-red-400 hover:text-white font-bold">Logout</button>
            </div>
        </nav>
    </header>

    <main class="pt-32 pb-20 px-4 max-w-4xl mx-auto space-y-8">

        <section class="glass p-8 flex flex-col md:flex-row gap-8 items-center md:items-start">

            <div class="flex flex-col items-center gap-4">
                <div class="relative group w-32 h-32">
                    <img id="profile-avatar" src="image/accicon.png"
                        class="w-full h-full rounded-full object-cover border-4 border-theme-orange shadow-lg">
                    <label for="avatar-input"
                        class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity text-white font-bold">
                        Change
                    </label>
                    <input type="file" id="avatar-input" class="hidden" accept="image/*"
                        onchange="handleAvatarUpload(this)">
                </div>
                <h2 class="text-2xl font-bold" id="display-name">User</h2>
            </div>

            <div class="flex-1 w-full space-y-4">
                <h3 class="text-xl font-bold text-theme-orange border-b border-white/20 pb-2">Profile
                    <button onclick="logout()"
                        class="flex items-center gap-2 px-6 py-2 bg-red-500/20 text-red-400 border border-red-500/50 rounded-lg hover:bg-red-500 hover:text-white transition-all font-bold text-sm">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </button>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-white/60 block mb-1">Username</label>
                        <input type="text" id="inp-username" class="profile-input">
                    </div>
                    <div>
                        <label class="text-sm text-white/60 block mb-1">Phone</label>
                        <input type="text" id="inp-phone" class="profile-input" placeholder="+123...">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm text-white/60 block mb-1">Email</label>
                        <input type="email" id="inp-email" class="profile-input opacity-50">
                    </div>
                </div>
                <button onclick="updateProfile()"
                    class="px-6 py-2 bg-white text-theme-orange font-bold rounded hover:bg-theme-orange hover:text-white transition-colors">
                    Save Changes
                </button>
            </div>
        </section>

        <section class="glass p-8">
            <h3 class="text-xl font-bold text-theme-orange mb-4 border-b border-white/20 pb-2">Continue Watching</h3>
            <div id="continue-watching-box"
                class="p-4 bg-white/5 rounded-lg border border-white/10 flex justify-between items-center">
                <div>
                    <p class="font-bold text-lg" id="last-watched-title">No history found</p>
                    <p class="text-sm text-white/50" id="last-watched-sub">Start watching anime to see progress here.
                    </p>
                </div>
                <a href="Anime.html" id="resume-btn"
                    class="hidden px-4 py-2 bg-white text-theme-orange rounded font-bold hover:bg-theme-orange hover:text-white transition-colors">
                    Resume
                </a>
            </div>
        </section>

        <section class="glass p-8">
            <h3 class="text-xl font-bold text-theme-orange mb-4 border-b border-white/20 pb-2">Favorites</h3>
            <div id="favorites-list" class="flex flex-col">
                <p class="text-white/50 italic">No favorites yet.</p>
            </div>
        </section>

    </main>
    <footer
        class="mt-auto py-8 text-center text-white/90 text-sm relative z-10 glass rounded-t-2xl mx-auto w-[95%] max-w-7xl mb-4">
        <p class="font-bold">&copy; 2026 The Apothecary Diaries Project.</p>
        <p class="mt-2 px-4 opacity-80 max-w-2xl mx-auto">
            <strong>Disclaimer:</strong> This website is developed strictly for
            <span class="text-theme-orange">educational and portfolio purposes only</span>.
            We do not own the rights to the anime, characters, or media content.
        </p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        let currentUser = null;

        document.addEventListener("DOMContentLoaded", async () => {
            await loadUserProfile();
        });

        async function loadUserProfile() {
            try {
                const res = await fetch('/auth/me?t=' + Date.now(), { credentials: 'include' });
                const data = await res.json();

                if (!data.loggedIn) {
                    window.location.href = 'auth.html';
                    return;
                }

                currentUser = data.user;


                document.getElementById('display-name').textContent = currentUser.username;
                document.getElementById('inp-username').value = currentUser.username;
                document.getElementById('inp-email').value = currentUser.email;
                document.getElementById('inp-phone').value = currentUser.phone || '';

                const avatarImg = document.getElementById('profile-avatar');
                if (currentUser.avatar_id && currentUser.avatar_id !== 'default') {
                    avatarImg.src = currentUser.avatar_id;
                }

                loadWatchHistory();

                renderFavoritesList();

            } catch (e) { console.error(e); }
        }

        async function loadWatchHistory() {
            try {
                const res = await fetch('/user/progress');
                const data = await res.json();
                if (data.continue) {
                    document.getElementById('last-watched-title').textContent = `Season ${data.continue.season} | Episode ${data.continue.episode}`;
                    document.getElementById('last-watched-sub').textContent = "Pick up where you left off";

                    const btn = document.getElementById('resume-btn');
                    btn.classList.remove('hidden');
                    btn.href = `stream.html?season=${data.continue.season}&ep=${data.continue.episode}`;
                }
            } catch (e) { }
        }

        function renderFavoritesList() {
            const listContainer = document.getElementById('favorites-list');

            if (!currentUser.favorite_episode || currentUser.favorite_episode === 'None' || currentUser.favorite_episode.trim() === '') {
                listContainer.innerHTML = '<p class="text-white/50 italic">No favorites added yet.</p>';
                return;
            }

            const favs = currentUser.favorite_episode.split(',').map(s => s.trim()).filter(s => s);

            listContainer.innerHTML = '';
            favs.forEach(fav => {
                const div = document.createElement('div');
                div.className = 'fav-item';
                div.innerHTML = `
                    <span class="font-bold text-sm">
                        <i class="fa-solid fa-heart text-red-500 mr-2"></i> ${fav}
                    </span>
                    <button onclick="removeFavorite('${fav}')" class="text-white/50 hover:text-red-400 transition-colors" title="Remove">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                listContainer.appendChild(div);
            });
        }

        window.removeFavorite = async (itemToRemove) => {
            if (!currentUser.favorite_episode) return;

            let favs = currentUser.favorite_episode.split(',').map(s => s.trim()).filter(s => s);
            favs = favs.filter(f => f !== itemToRemove);

            const newFavString = favs.join(', ');

            try {
                const res = await fetch('/auth/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        favorite_episode: newFavString
                    })
                });

                if (res.ok) {
                    currentUser.favorite_episode = newFavString;
                    renderFavoritesList();
                    Toastify({ text: "Removed from favorites", style: { background: "#333" } }).showToast();
                } else {
                    Toastify({ text: "Failed to remove", style: { background: "#ff5f6d" } }).showToast();
                }
            } catch (err) { console.error(err); }
        };

        window.updateProfile = async () => {
            const username = document.getElementById('inp-username').value;
            const phone = document.getElementById('inp-phone').value;

            try {
                const res = await fetch('/auth/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, phone })
                });
                if (res.ok) {
                    Toastify({ text: "Profile Updated", style: { background: "#00b09b" } }).showToast();
                    document.getElementById('display-name').textContent = username;
                }
            } catch (e) { console.error(e); }
        };

        window.handleAvatarUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const res = await fetch('/auth/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: currentUser.username, avatar_id: e.target.result })
                    });
                    if (res.ok) {
                        document.getElementById('profile-avatar').src = e.target.result;
                        Toastify({ text: "Avatar Updated", style: { background: "#00b09b" } }).showToast();
                    }
                } catch (err) { }
            };
            reader.readAsDataURL(file);
        };

        window.logout = async () => {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = 'Anime.html';
        };

    </script>
</body>

</html>